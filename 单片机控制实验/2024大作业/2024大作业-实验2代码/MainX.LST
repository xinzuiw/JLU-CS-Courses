C51 COMPILER V9.60.0.0   MAINX                                                             12/07/2024 17:48:00 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAINX
OBJECT MODULE PLACED IN MainX.OBJ
COMPILER INVOKED BY: C:\Program Files\C51\BIN\C51.EXE MainX.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include<reg51.h>
   2          #include<stdio.h>
   3          #include<intrins.h>
   4          #include<string.h>
   5          #include<stdlib.h>
   6          
   7          // å®šä¹‰è®¡æ—¶ç›¸å…³çš„å®
   8          #define TICK_TIME_US_2000 2000  // æ¯ä¸ªtickå‘¨æœŸä¸º2000å¾®ç§’
   9          #define TICK_PER_SEC_500 500    // æ¯ç§’500ä¸ªtick
  10          #define TIMER_0_PRESET_VALUE TICK_TIME_US_2000  // å®šæ—¶å™¨0é¢„è®¾å€¼
  11          
  12          // å¤–éƒ¨å˜é‡å’Œå‡½æ•°å£°æ˜
  13          extern unsigned char temperature_value[];
  14          extern void delay_ms(unsigned int x);
  15          extern void LCD_Initialize();
  16          extern void LCD_String(unsigned char r,unsigned char c,unsigned char *str);
  17          extern unsigned char ds18b20_read_temperature();
  18          extern void motor_control();
  19          extern void motor_stop();
  20          extern void init_timer1_pwm();
  21          
  22          // æ˜¾ç¤ºç¼“å†²åŒºå®šä¹‰
  23          unsigned char display_upper_buffer[16];  // ä¸ŠåŠéƒ¨åˆ†æ˜¾ç¤ºç¼“å†²åŒº
  24          unsigned char display_down_buffer[16];   // ä¸‹åŠéƒ¨åˆ†æ˜¾ç¤ºç¼“å†²åŒº
  25          unsigned char ticks = 0;  // è®¡æ—¶tickè®¡æ•°
  26          unsigned char i;          // å¾ªç¯å˜é‡
  27          unsigned char duty_cycle; // å ç©ºæ¯”
  28          
  29          // æ¸©åº¦å˜é‡å®šä¹‰
  30          float present_temp = 0.0;  // å½“å‰æ¸©åº¦
  31          float target_temp = 0.0;  // ç›®æ ‡æ¸©åº¦
  32          float new_temp = 0.0;     // æ–°è¯»å–çš„æ¸©åº¦
  33          
  34          // å®šä¹‰æ§åˆ¶æŒ‰é’®å¼•è„š
  35          sbit P33 = P3^3;  // å¼€å…³
  36          sbit P34 = P3^4;  // +0.5æ¸©åº¦è°ƒèŠ‚
  37          sbit P35 = P3^5;  // +1æ¸©åº¦è°ƒèŠ‚
  38          sbit P36 = P3^6;  // +2æ¸©åº¦è°ƒèŠ‚
  39          sbit P37 = P3^7;  // +4æ¸©åº¦è°ƒèŠ‚
  40          
  41          // åˆå§‹åŒ–å®šæ—¶å™¨0ä¸­æ–­
  42          void init_timer0_interrupt()
  43          {
  44   1          TMOD = 0x01;  // å®šæ—¶å™¨0å·¥ä½œåœ¨æ¨¡å¼1
  45   1          TH0 = (65536 - TIMER_0_PRESET_VALUE) / 256;  // è®¾ç½®å®šæ—¶å™¨é«˜8ä½
  46   1          TL0 = (65536 - TIMER_0_PRESET_VALUE) % 256;  // è®¾ç½®å®šæ—¶å™¨ä½8ä½
  47   1          TR0 = 1;  // å¯åŠ¨å®šæ—¶å™¨0
  48   1          ET0 = 1;  // ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
  49   1          IT0 = 1;  // å¤–éƒ¨ä¸­æ–­0è®¾ç½®ä¸ºä½ç”µå¹³è§¦å‘
  50   1          EX0 = 1;  // ä½¿èƒ½å¤–éƒ¨ä¸­æ–­0
  51   1          EA = 1;   // å…¨å±€ä¸­æ–­ä½¿èƒ½
  52   1      }
  53          
  54          // è¯»å–å½“å‰æ¸©åº¦å‡½æ•°
  55          void readPresentTemp()
C51 COMPILER V9.60.0.0   MAINX                                                             12/07/2024 17:48:00 PAGE 2   

  56          {
  57   1          EA = 0;  // ç¦ç”¨ä¸­æ–­
  58   1          ds18b20_read_temperature();  // è¯»å–æ¸©åº¦
  59   1          delay_ms(50);
  60   1          present_temp = (((int)temperature_value[1]<<8)|((int)temperature_value[0]))*0.0625;  // è½¬æ¢æ¸©åº¦å€
             -¼
  61   1          EA = 1;  // ä½¿èƒ½ä¸­æ–­
  62   1          
  63   1          // æ›´æ–°æ˜¾ç¤ºç¼“å†²åŒº
  64   1          for (i = 0; i < 15; i++)
  65   1          {
  66   2              display_upper_buffer[i] = display_upper_buffer[i+1];
  67   2              display_down_buffer[i] = display_down_buffer[i+1];
  68   2          }
  69   1          
  70   1          // æ ¹æ®æ¸©åº¦æ›´æ–°æ˜¾ç¤º
  71   1          if (present_temp < 10)
  72   1          {
  73   2              display_upper_buffer[15] = ' ';
  74   2              display_down_buffer[15] = '_';
  75   2          }
  76   1          else if (present_temp < 12.5)
  77   1          {
  78   2              display_upper_buffer[15] = ' ';
  79   2              display_down_buffer[15] = '#';
  80   2          }
  81   1          else
  82   1          {
  83   2              display_upper_buffer[15] = '#';
  84   2              display_down_buffer[15] = '#';
  85   2          }
  86   1      }
  87          
  88          // å®šæ—¶å™¨0ä¸­æ–­æœåŠ¡å‡½æ•°
  89          void time0ISR() interrupt 1
  90          {
  91   1          motor_control();  // æ§åˆ¶ç”µæœº
  92   1          ticks++;
  93   1          if ((ticks % TICK_PER_SEC_500) == 0)  // æ¯ç§’è¯»å–ä¸€æ¬¡æ¸©åº¦
  94   1          {
  95   2              readPresentTemp();
  96   2          }
  97   1          TH0 = (65536 - TIMER_0_PRESET_VALUE) / 256;  // é‡æ–°åŠ è½½å®šæ—¶å™¨å€¼
  98   1          TL0 = (65536 - TIMER_0_PRESET_VALUE) % 256;
  99   1      }
 100          
 101          // è¯»å–ç›®æ ‡æ¸©åº¦å‡½æ•°
 102          void readTargetTemp()
 103          {
 104   1          unsigned char bit34 = (unsigned char)P34;
 105   1          unsigned char bit35 = (unsigned char)P35;
 106   1          unsigned char bit36 = (unsigned char)P36;
 107   1          unsigned char bit37 = (unsigned char)P37;
 108   1          new_temp = 10 + bit34*0.5 + bit35*1 + bit36*2 + bit37*4;
 109   1          target_temp = new_temp;
 110   1      }
 111          
 112          // æ˜¾ç¤ºå±å¹•å†…å®¹å‡½æ•°
 113          void printScreen()
 114          {
 115   1          unsigned char buffer[16];
 116   1          //EA = 0;  // ç¦ç”¨ä¸­æ–­
C51 COMPILER V9.60.0.0   MAINX                                                             12/07/2024 17:48:00 PAGE 3   

 117   1          if (P33)
 118   1          {
 119   2              sprintf(buffer, "  targ: %5.2f\xDF\x43", target_temp);
 120   2              LCD_String(0, 0, buffer);
 121   2              sprintf(buffer, "  pres: %5.2f\xDF\x43", present_temp);
 122   2              LCD_String(1, 0, buffer);
 123   2          }
 124   1          else
 125   1          {
 126   2              LCD_String(0, 0, display_upper_buffer);
 127   2              LCD_String(1, 0, display_down_buffer);
 128   2          }
 129   1          //EA = 1;  // ä½¿èƒ½ä¸­æ–­
 130   1      }
 131          
 132          // ä¸»å‡½æ•°
 133          void main()
 134          {
 135   1          target_temp = 0.0;
 136   1          present_temp = 0.0;
 137   1          duty_cycle = 0;
 138   1          
 139   1          init_timer0_interrupt();  // åˆå§‹åŒ–å®šæ—¶å™¨0
 140   1          init_timer1_pwm();       // åˆå§‹åŒ–å®šæ—¶å™¨1
 141   1          
 142   1          LCD_Initialize();        // åˆå§‹åŒ–LCD
 143   1          LCD_String(0, 0, "2024 Final Exp 2");
 144   1          LCD_String(1, 0, "    waiting...  ");
 145   1          
 146   1          delay_ms(200);
 147   1          
 148   1          while(1)
 149   1          {
 150   2              readTargetTemp();  // è¯»å–ç›®æ ‡æ¸©åº¦
 151   2              printScreen();     // æ›´æ–°å±å¹•æ˜¾ç¤º
 152   2              delay_ms(50);
 153   2          }
 154   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    587    ----
   CONSTANT SIZE    =     66    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     47      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
